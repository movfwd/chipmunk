# Setup 

There are three versions of the fuzzer that are used in crash consistency testing

- No Test 
  - Restricts the fuzzer to test certain file system syscalls but doesn't perform crash consistency testing)
- Test 
  - Restricts the fuzzer to test certain file system syscalls and for every test generated by the fuzzer will run the crash monkey tester)
- Test + Mount Cov 
  - Restricts the fuzzer to test certain file system syscalls and for every test generated by the fuzzer will run the crash monkey tester and collect the mount coverage from mounting all the crash states)

This document details how to get these fuzzers running
## Kernel Configs
Look [here](https://github.com/shankarapailoor/syzkaller/blob/master/docs/linux/setup_ubuntu-host_qemu-vm_x86-64-kernel.md) for the recommended Syzkaller kernel configs. The main ones to add for crash consistency are ``CONFIG_KCOV`` and ``CONFIG_DEBUG_FS``. You also need to make sure that your gcc version is high enough (> 6) to instrument the kernel.

## Fuzzing Configs
Syzkaller takes as input a config file which specifies the fuzzing parameters. Here is my fuzzing config

```json
{
	"target": "linux/amd64",
	"http": "127.0.0.1:56741",
	"workdir": "/home/shankara/go/src/github.com/google/syzkaller/workdir3",
	"kernel_obj": "/home/shankara/shared/nova/",
	"image": "/home/shankara/nova-image/stretch.img",
	"sshkey": "/home/shankara/nova-image/stretch.id_rsa",
	"syzkaller": "/home/shankara/go/src/github.com/google/syzkaller",
	"procs": 1,
	"sandbox":"none",
	"type": "qemu",
	"crash_consistency": true,
	"capture_mount_cov": true,
	"cover": true,
	"reproduce": false,
	"disable_syscalls": ["write$binfmt_script", "write$*", "open$*"],
	"enable_syscalls": [ "open","write","read","rename","unlink","truncate","ftruncate","symlink","close","fsync","fdatasync","link","mkdir","rmdir","fallocate"],
	"vm": {
		"count": 1,
		"kernel": "/home/shankara/shared/nova/arch/x86/boot/bzImage",
		"cpu": 1,
		"mem": 4096
	}
}

```

- ``workdir`` 
  - syzkaller will store the saved tests and bugs it discovers in this directory
- ``sshkey``
  - you need to generate an ssh key for your image and give syzkaller the path to your private key (it expects your public key to be in the same location)
- ``procs``
  - The fuzzer consists of a centralized manager process which keeps and organizes all the tests and a bunch of fuzzing processes on each VM used to fuzz. This parameter controls the number of fuzzing processes and we want that to be 1 during crash consistency testing.
- ``sandbox``
  - There are various techniques the fuzzer uses to isolate processes so they don't corrupt the disk (namespaces, userids, etc). However, in our case, we want the fuzzing process to be able to write to global directories like ``/mnt/pmem`` so we set this to none
-  ``crash_consistency``
	- Tells syzkaller to use either the Test or Test + MountCov versions
- ``capture_mount_cov``
	- Combined with crash_consistency fully specifies the Test + MountCov option
- ``reproduce``
	- This option tells syzkaller to stop fuzzing and try to reproduce a bug when there is a kernel panic. We turn this off because we may have spurious "crashes" (due to bugs in our implementation for example) and it will slow down fuzzing a lot.
 
# Running Syzkaller
Go to the syzkaller directory and run the command ``./bin/syz-manager -config /path/to/config/file``. If the fuzzing process is working you should see the following in a few seconds
```
[sudo] password for shankara: 
2021/07/19 13:16:28 loading corpus...
2021/07/19 13:16:28 serving http on http://127.0.0.1:56741
2021/07/19 13:16:28 serving rpc on tcp://[::]:37707
2021/07/19 13:16:28 booting test machines...
2021/07/19 13:16:28 wait for the connection from test machine...
2021/07/19 13:16:39 CRASH CONSISTENCY: true, MOUNT COV: true
2021/07/19 13:16:42 disabling read$eventfd: no syscalls can create resource fd_event, enable some syscalls that can create it [eventfd eventfd2]
2021/07/19 13:16:42 disabling read$hiddev: no syscalls can create resource fd_hiddev, enable some syscalls that can create it [syz_open_dev$hiddev]
2021/07/19 13:16:42 disabling read$alg: no syscalls can create resource sock_algconn, enable some syscalls that can create it [accept$alg accept4$alg]
2021/07/19 13:16:42 disabling read$snddsp: no syscalls can create resource fd_snd_dsp, enable some syscalls that can create it [syz_open_dev$sndpcmc syz_open_dev$sndpcmp]
2021/07/19 13:16:42 disabling read$proc_mixer: no syscalls can create resource fd_proc_mixer, enable some syscalls that can create it [openat$proc_mixer]
2021/07/19 13:16:42 disabling read$smackfs_access: LSM smack is not enabled
2021/07/19 13:16:42 disabling read$smackfs_logging: LSM smack is not enabled
2021/07/19 13:16:42 disabling read$ptp: no syscalls can create resource fd_ptp, enable some syscalls that can create it [openat$ptp0 openat$ptp1]
2021/07/19 13:16:42 disabling close$ibv_device: no syscalls can create resource fd_rdma, enable some syscalls that can create it [openat$uverbs0]
2021/07/19 13:16:42 disabling read$usbmon: no syscalls can create resource fd_usbmon, enable some syscalls that can create it [syz_open_dev$usbmon]
2021/07/19 13:16:42 disabling read$sequencer: no syscalls can create resource fd_seq, enable some syscalls that can create it [openat$sequencer openat$sequencer2]
2021/07/19 13:16:42 disabling read$trusty: no syscalls can create resource fd_trusty, enable some syscalls that can create it [openat$trusty openat$trusty_avb openat$trusty_gatekeeper openat$trusty_hwkey openat$trusty_hwrng openat$trusty_km openat$trusty_km_secure openat$trusty_storage]
2021/07/19 13:16:42 disabling read$snapshot: no syscalls can create resource fd_snapshot, enable some syscalls that can create it [openat$snapshot]
2021/07/19 13:16:42 disabling read$char_usb: no syscalls can create resource fd_char_usb, enable some syscalls that can create it [syz_open_dev$char_usb]
2021/07/19 13:16:42 disabling read$smackfs_cipsonum: LSM smack is not enabled
2021/07/19 13:16:42 disabling read$fb: no syscalls can create resource fd_fb, enable some syscalls that can create it [openat$fb0 openat$fb1]
2021/07/19 13:16:42 disabling read$hidraw: no syscalls can create resource fd_hidraw, enable some syscalls that can create it [syz_open_dev$hidraw]
2021/07/19 13:16:42 disabling read$qrtrtun: no syscalls can create resource fd_qrtr_tun, enable some syscalls that can create it [openat$qrtrtun]
2021/07/19 13:16:42 disabling read$usbfs: no syscalls can create resource fd_usbfs, enable some syscalls that can create it [syz_open_dev$usbfs]
2021/07/19 13:16:42 disabling read$char_raw: no syscalls can create resource fd_char_raw, enable some syscalls that can create it [syz_open_dev$char_raw]
2021/07/19 13:16:42 disabling read$FUSE: no syscalls can create resource fd_fuse, enable some syscalls that can create it [openat$cuse openat$fuse]
2021/07/19 13:16:42 disabling read$smackfs_ptrace: LSM smack is not enabled
2021/07/19 13:16:42 disabling read$rfkill: no syscalls can create resource fd_rfkill, enable some syscalls that can create it [openat$rfkill]
2021/07/19 13:16:42 disabling read$midi: no syscalls can create resource fd_midi, enable some syscalls that can create it [syz_open_dev$admmidi syz_open_dev$amidi syz_open_dev$dmmidi syz_open_dev$midi syz_open_dev$sndmidi]
2021/07/19 13:16:42 disabling read$dsp: no syscalls can create resource fd_dsp, enable some syscalls that can create it [openat$adsp1 openat$audio openat$audio1 openat$dsp openat$dsp1]
2021/07/19 13:16:42 disabling read$sndhw: no syscalls can create resource fd_snd_hw, enable some syscalls that can create it [syz_open_dev$sndhw]
2021/07/19 13:16:42 machine check:
2021/07/19 13:16:42 syscalls                : 15/4114
2021/07/19 13:16:42 code coverage           : enabled
2021/07/19 13:16:42 comparison tracing      : CONFIG_KCOV_ENABLE_COMPARISONS is not enabled
2021/07/19 13:16:42 extra coverage          : extra coverage is not supported by the kernel
2021/07/19 13:16:42 setuid sandbox          : enabled
2021/07/19 13:16:42 namespace sandbox       : /proc/self/ns/user does not exist
2021/07/19 13:16:42 Android sandbox         : enabled
2021/07/19 13:16:42 fault injection         : CONFIG_FAULT_INJECTION is not enabled
2021/07/19 13:16:42 leak checking           : CONFIG_DEBUG_KMEMLEAK is not enabled
2021/07/19 13:16:42 net packet injection    : /dev/net/tun does not exist
2021/07/19 13:16:42 net device setup        : enabled
2021/07/19 13:16:42 concurrency sanitizer   : /sys/kernel/debug/kcsan does not exist
2021/07/19 13:16:42 devlink PCI setup       : PCI device 0000:00:10.0 is not available
2021/07/19 13:16:42 USB emulation           : /dev/raw-gadget does not exist
2021/07/19 13:16:42 hci packet injection    : /dev/vhci does not exist
2021/07/19 13:16:42 wifi device emulation   : /sys/class/mac80211_hwsim/ does not exist
2021/07/19 13:16:42 802.15.4 emulation      : /sys/bus/platform/devices/mac802154_hwsim does not exist
2021/07/19 13:16:42 corpus                  : 120 (deleted 0 broken)
2021/07/19 13:16:43 seeds                   : 0/678
2021/07/19 13:16:48 VMs 1, executed 3, cover 0, signal 0/2308, crashes 0, repro 0
2021/07/19 13:16:58 VMs 1, executed 3, cover 1116, signal 137/2308, crashes 0, repro 0
2021/07/19 13:17:08 VMs 1, executed 11, cover 2297, signal 2347/2308, crashes 0, repro 0
2021/07/19 13:17:18 VMs 1, executed 20, cover 4182, signal 2472/2921, crashes 0, repro 0
2021/07/19 13:17:28 VMs 1, executed 29, cover 4288, signal 2689/2921, crashes 0, repro 0
```
## Debugging 

### Fuzzing
To capture debug output during the fuzzing process run ```./bin/syz-manager /path/to/my/cfg -debug``` and it should 1) log all debug messages in both the executor, fuzzer, and manager. This is usually a lot of information so you should redirect ``stdout`` and ``stderr`` to files. 

### Isolated Test
Sometimes we may want to run an isolated test to reproduce a crash or an implementation bug. We have a tool ``syz-execprog`` which executes a list of syzkaller programs. 

- ``mkdir /path/to/shared/syzkallerBinaries`` (create a folder in your shared directory to keep syzkaller binaries)
- ``cd /path/to/syzkaller && make -j4`` (build syzkaller)
- ``cp -R bin/* /path/to/shared/syzkallerBinaries``
- Bootup your VM in qemu and make sure to mount the shared directory.
- ``cp -R /path/to/shared/dir/on/vm .``
- ``cd syzkallerBinaries/linux_amd64``
- ``./bin/syz-execprog -crashConsistency -mountCov /path/to/program``
